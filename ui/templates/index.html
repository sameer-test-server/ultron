{% extends "base.html" %}

{% block title %}Ultron Dashboard{% endblock %}

{% block content %}
<div class="dashboard-shell">
    <section class="card hero-panel hero-panel--dashboard mb-4">
        <div class="hero-left">
            <p class="hero-kicker mb-2">AUTONOMOUS MARKET INTELLIGENCE</p>
            <h1 class="h2 mb-2">Ultron NIFTY 50 Command Center</h1>
            <p class="text-body-secondary mb-0">Signal-driven watchlist, live quote tracker, and paper-trade scoring in one view.</p>
        </div>
        <div class="hero-right">
            <div class="hero-meta-item">
                <span class="meta-label">Last Updated</span>
                <span class="meta-value">{{ last_run.strftime('%b %d, %H:%M:%S') if last_run else 'N/A' }}</span>
            </div>
            <div class="hero-meta-item">
                <span class="meta-label">Regime Filter</span>
                <span class="meta-value">{{ regime_filter }}</span>
            </div>
            <div class="hero-meta-item">
                <span class="meta-label">Sort Mode</span>
                <span class="meta-value">{{ sort_by.replace('_', ' ')|title }}</span>
            </div>
        </div>
    </section>

    {% if processing %}
    <div id="analysisProcessingCard" class="alert alert-info d-flex align-items-center mb-4" role="alert" data-poll-seconds="{{ analysis_poll_seconds }}">
        <div class="spinner-border spinner-border-sm me-3" role="status" aria-hidden="true"></div>
        <div id="analysisProcessingMessage" class="small">{{ analysis_message }}...</div>
    </div>
    {% endif %}

    <section class="kpi-strip mb-4">
        <article class="card stat-card" style="--i: 0;">
            <div class="stat-value">{{ total_analyzed }}</div>
            <div class="stat-label">Stocks Covered</div>
        </article>
        <article class="card stat-card" style="--i: 1;">
            <div class="stat-value text-success">{{ long_term_count }}</div>
            <div class="stat-label">Long-Term Signals</div>
        </article>
        <article class="card stat-card" style="--i: 2;">
            <div class="stat-value text-danger">{{ short_term_count }}</div>
            <div class="stat-label">Short-Term Signals</div>
        </article>
        <article class="card stat-card" style="--i: 3;">
            <div class="stat-value text-success">{{ '%.2f'|format(best_return) }}%</div>
            <div class="stat-label">Best Return</div>
        </article>
        <article class="card stat-card" style="--i: 4;">
            <div class="stat-value text-danger">{{ '%.2f'|format(worst_return) }}%</div>
            <div class="stat-label">Worst Return</div>
        </article>
    </section>

    <div class="row g-4 align-items-start">
        <div class="col-12 col-xl-8">
            <section class="card p-3 p-lg-4 mb-4 control-panel">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2 class="h6 mb-0">Filter & Search</h2>
                    <span class="text-body-secondary small">{{ displayed_count }} visible / {{ total_analyzed }} total</span>
                </div>
                <form id="dashboardFilterForm" method="get" action="{{ url_for('index') }}" class="row g-2 align-items-center">
                    <div class="col-md-3">
                        <select id="regimeSelect" name="regime" class="form-select form-select-sm">
                            <option value="ALL" {% if regime_filter == 'ALL' %}selected{% endif %}>All Regimes</option>
                            <option value="LONG_TERM" {% if regime_filter == 'LONG_TERM' %}selected{% endif %}>Long-Term</option>
                            <option value="SHORT_TERM" {% if regime_filter == 'SHORT_TERM' %}selected{% endif %}>Short-Term</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select id="sortSelect" name="sort" class="form-select form-select-sm">
                            <option value="highest_return" {% if sort_by == 'highest_return' %}selected{% endif %}>Sort: Highest Return</option>
                            <option value="lowest_risk" {% if sort_by == 'lowest_risk' %}selected{% endif %}>Sort: Lowest Risk</option>
                            <option value="highest_confidence" {% if sort_by == 'highest_confidence' %}selected{% endif %}>Sort: Highest Confidence</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <input id="tickerSearch" type="search" class="form-control form-control-sm" placeholder="Search ticker (e.g. RELIANCE)" aria-label="Search ticker">
                    </div>
                    <div class="col-md-2 d-grid">
                        <button type="submit" class="btn btn-sm btn-primary">Apply</button>
                    </div>
                </form>
            </section>

            <section class="card stock-grid-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h2 class="h6 mb-0">Stock Overview</h2>
                    <span class="small text-body-secondary">Click a row to open full detail</span>
                </div>
                <div class="table-responsive">
                    <table id="overviewTable" class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Ticker</th>
                                <th>Regime</th>
                                <th class="text-center">Confidence</th>
                                <th class="text-center">Volatility</th>
                                <th class="text-end">Win Rate</th>
                                <th class="text-end">Hypothetical Return</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stock in stocks %}
                            <tr class="click-row" data-href="{{ url_for('stock_detail', ticker=stock.ticker) }}" data-ticker="{{ stock.ticker }}">
                                <td><span class="font-monospace fw-bold">{{ stock.ticker }}</span></td>
                                <td>
                                    <span class="badge rounded-pill {{ 'bg-success-soft' if stock.regime == 'LONG_TERM' else 'bg-danger-soft' }}">
                                        {{ stock.regime }}
                                    </span>
                                </td>
                                <td class="text-center">
                                    <div class="confidence-bar mx-auto" title="{{ stock.confidence_label }} ({{ (stock.confidence * 100) | round(0) }}%)">
                                        <div class="confidence-bar-inner" style="width: {{ (stock.confidence * 100)|round(0) }}%"></div>
                                    </div>
                                </td>
                                <td class="text-center">
                                    <span class="badge rounded-pill bg-secondary-soft">{{ stock.volatility_label }}</span>
                                </td>
                                <td class="text-end font-monospace small">{{ '%.1f'|format(stock.simulation.win_rate) }}%</td>
                                <td class="text-end font-monospace fw-bold {{ 'text-success' if stock.hypothetical_return_pct >= 0 else 'text-danger' }}">
                                    {{ '%+.2f'|format(stock.hypothetical_return_pct) }}%
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="6" class="text-center py-5">
                                    <h4 class="mb-1">No stocks found</h4>
                                    <p class="text-body-secondary">{{ 'Analysis is processing...' if processing else 'No stocks match the selected filters.' }}</p>
                                </td>
                            </tr>
                            {% endfor %}
                            <tr id="noSearchRows" style="display: none;">
                                <td colspan="6" class="text-center py-5"><h4 class="mb-1">No stocks match your search.</h4></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </div>

        <div class="col-12 col-xl-4">
            <section class="card p-3 p-lg-4 mb-4 pulse-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2 class="h6 mb-0">Market Pulse</h2>
                    <span id="marketTrendBadge" class="badge rounded-pill bg-secondary-soft">Waiting</span>
                </div>
                <p id="marketPulseText" class="small text-body-secondary mb-3">Live tracker will compute market breadth after first refresh.</p>
                <div class="pulse-metrics">
                    <div>
                        <span class="pulse-label">Advancing</span>
                        <strong id="marketUpCount">0</strong>
                    </div>
                    <div>
                        <span class="pulse-label">Declining</span>
                        <strong id="marketDownCount">0</strong>
                    </div>
                    <div>
                        <span class="pulse-label">Unchanged</span>
                        <strong id="marketFlatCount">0</strong>
                    </div>
                </div>
            </section>

            <section class="card mb-4 live-tracker" data-tickers="{{ live_tracker_tickers|join(',') }}" data-refresh-seconds="{{ live_refresh_seconds }}">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h2 class="h6 mb-0">Live Tracker</h2>
                    <span id="liveTrackerStatus" class="badge rounded-pill bg-secondary-soft">Loading...</span>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm mb-0">
                        <thead>
                            <tr>
                                <th>Ticker</th>
                                <th class="text-end">Price</th>
                                <th class="text-end">Change</th>
                            </tr>
                        </thead>
                        <tbody id="liveQuotesBody">
                            <tr><td colspan="3" class="text-center small text-body-secondary py-3">Initializing...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="px-3 py-2 border-top small text-body-secondary">
                    Last quote refresh: <span id="liveTrackerUpdated">--</span>
                </div>
            </section>

            <section class="card">
                <div class="card-header">
                    <h2 class="h6 mb-0">52W Breakout Watch</h2>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm mb-0">
                        <thead>
                            <tr>
                                <th>Ticker</th>
                                <th>Status</th>
                                <th class="text-end">Dist. To High</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in breakout_watchlist %}
                            <tr>
                                <td><span class="font-monospace small">{{ item.ticker }}</span></td>
                                <td class="small">{{ item.label }}</td>
                                <td class="text-end font-monospace small {{ 'text-success' if (item.distance_to_high_pct or 0) >= 0 else 'text-danger' }}">
                                    {% if item.distance_to_high_pct is not none %}{{ '%+.2f'|format(item.distance_to_high_pct) }}%{% else %}N/A{% endif %}
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="3" class="text-center small text-body-secondary py-3">No candidates found.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </section>
        </div>
    </div>

    {% if errors %}
    <section class="card mt-4 p-3 p-lg-4">
        <details>
            <summary class="fw-semibold">Skipped Tickers ({{ errors|length }})</summary>
            <div class="table-responsive mt-3">
                <table class="table table-sm table-striped mb-0">
                    <thead><tr><th>Ticker</th><th>Reason</th></tr></thead>
                    <tbody>
                        {% for ticker, reason in errors.items() %}
                        <tr><td><span class="font-monospace small">{{ ticker }}</span></td><td><small>{{ reason }}</small></td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </details>
    </section>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}
